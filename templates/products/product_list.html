{% extends 'products/base.html' %}
{% block content %}

    <body onload="load()" style="background-color:#BEBEBE">
        <header class="page-header">
            <div class="container" style="text-align:center">
                <h1 style="text-align:center" style="color:green"><b>Amazon Price Alert App</b></h1>
            </div>
        </header>

        <center>
            <div float="left" style="text-align:center">
                <p>Amazon-Link:</p>
                <input id="amzn_url" name="amzn_url" style="display: inline-block; width: 800px">
                <br>
                <p>Wunschpreis:</p>
                <input id="desired_price" name="desired_price">
                <p>€</p>
            </div>
            <br>
            <button id="add_product_to_list" type="submit" name="add_product_btn" value="add_btn">Hinzufügen</button>
        </center>

        <table className="padding-table-columns" class="styled-table">
            <!-- data attribute names -->
            <thead>
                <tr>
                    <th style="width:5%;">Bild</th>
                    <th style="width:20%">Titel</th>
                    <th style="width:5%">URL</th>
                    <th style="width:5%">Aktueller Preis</th>
                    <th style="width:10%">Wunschpreis</th>
                    <th style="width:5%">Löschen</th>
                </tr>
            </thead>


            <!-- data sets -->
            <tbody class="product_body">

            </tbody>
        </table>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript">
        var port = 7000;
        function load() {
            // refresh page every x seconds
            //var refresh_time_seconds = 60;
            //setTimeout("window.open('http://127.0.0.1:' + port.toString(), '_self');", refresh_time_seconds * 1000);
        }
        function add_new_product_entry(product_image, product_title, product_url, product_price, product_preferred_price) {
            var price_color = "red"
            console.log(product_price, product_preferred_price)
            if (product_price <= product_preferred_price) {
                price_color = 'green'
            }
            var product_tag = `
                <tr style="text-align: center">
                    <td>
                        <img style='display:block; height:100px;' src=${product_image}>
                    </td>
                    <td>
                        ${product_title}
                    </td>
                    <td>
                        <a href=${product_url}>${product_url}</a>
                    </td>
                    <td>
                        <font face='cursive,serif' style="color:${price_color}" size="8px">${product_price}</font>
                    </td>
                    <td>
                        <font face='cursive,serif' size="8px">${product_preferred_price}€</font>
                    </td>
                    <td>
                        <button type='submit' value='delete' id='delete_btn'>Entfernen</button>
                    </td>
                </tr>
            `
            return product_tag
        }

            $(document).ready(function () {
                /* List product list */
                $.ajax({
                    type: 'GET',
                    url: '/product_list/',
                    dataType: 'json',
                }).done(function (response) {
                    for (var product of response['products']) {
                        console.log(product)
                        temp = add_new_product_entry(
                            product['image'], product['title'], product['url'], product['price'].slice(0, -1), product['preferred_price'])

                        $('.product_body').append(temp)
                    }
                });

                // event called when add button is clicked
                $('#add_product_to_list').click(function (e) {
                    /* Event after clicking button to add product */
                    e.preventDefault();
                    var amzn_url = $('#amzn_url').val();
                    var desired_price = $('#desired_price').val();

                    // send a GET request to build the list of todos
                    $.ajax({
                        url: '/add_product/',
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            'amzn_url': amzn_url,
                            'desired_price': desired_price
                        },
                    }).done(function (response) {
                        //if (response['status'] == 'new_product') {
                            var product = response // check if product contains all attributes (later)
                            product['price'] = parseFloat(product['price'].replace(/,/g, '')) // convert string to float
                            if (product['preferred_price'].includes('.')) {
                                product['preferred_price'] = parseFloat(product['preferred_price'].replace(/,/g, ''))
                            } else if (product['preferred_price'].includes(',')) {
                                var temp = product['preferred_price'].split(',')
                                var before_comma = parseInt(temp[0])
                                var after_comma = parseInt(temp[1]) / (10 ** temp[1].length)
                                product['preferred_price'] = parseFloat(before_comma + after_comma)
                            }
                            temp = add_new_product_entry(
                                product['image'], product['title'], product['url'], product['price'], product['preferred_price'])
                            $('.product_body').append(temp)
                       // }
                    })
                    $('#amzn_url').val('') // reset the input field
                    $('#desired_price').val('') // reset the input field
                });

                // called when delete button is clicked
                $('tbody').on('click', '#delete_btn', function(event) {
                    event.stopPropagation()
                    var current_product = $(this).parent().parent()
                    var current_product_link = current_product.find('a').text() // find unique element which is the url link

                    $.ajax({
                        url: "/delete_product/",
                        type: 'POST',
                        data: {
                          'current_product_link': current_product_link,
                        },
                    }).done(function(response) {
                        if (response['status'] === 'deleted') {
                            current_product.remove()
                        }
                    })
                })
            })
    </script>
    </body>

{% endblock %}
